package nu.ndw.nls.geometry.jts.matchers;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import lombok.SneakyThrows;
import nu.ndw.nls.geometry.crs.CrsTransformer;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.locationtech.jts.geom.LineString;
import org.locationtech.jts.geom.MultiLineString;
import org.locationtech.jts.geom.Point;
import org.locationtech.jts.io.WKTReader;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = {MultiLineStringPointGeometryMatcher.class, CrsTransformer.class})
class MultiLineStringPointGeometryMatcherIT {

    private static final String WKT_EXPECTED_LINE_STRING = """
            LINESTRING (4.933860299886775 52.36636058084766, 4.933852599886767 52.36651408084748, 4.9337569998866755 52.36843618084453, 4.933789799886711 52.368796280843995, 4.933933299886851 52.36930788084323, 4.9341348998870505 52.36981888084248, 4.934156899887073 52.37111368084054, 4.934111699887031 52.3716435808397, 4.933747599886676 52.37240528083857, 4.933415599886355 52.37284078083792, 4.932615799885573 52.373485080836915, 4.931863499884839 52.373934180836265, 4.931277299884262 52.37419148083583, 4.930283799883297 52.37459778083527, 4.929025299882063 52.37505058083457, 4.928134199881196 52.37525358083425, 4.92468119987782 52.37585678083335, 4.9163435998696725 52.37702378083154, 4.914395399867767 52.37724608083119, 4.912754199866162 52.377385380830965, 4.911597099865033 52.37746798083084, 4.910334999863798 52.37755078083071, 4.907201099860736 52.377949780830114, 4.9050414998586245 52.378227580829666, 4.903996699857606 52.37850308082924, 4.903202299856827 52.378754780828864, 4.902009499855663 52.37923438082821, 4.899939099853641 52.37995258082705, 4.897659399851415 52.38074638082583, 4.8972168998509815 52.38092888082558, 4.896966299850737 52.38108018082536, 4.8967469998505235 52.38121258082513, 4.896339799850124 52.381452080824786, 4.89554389984935 52.382140580823744, 4.8951078998489255 52.382488080823194, 4.894646999848474 52.38269718082287, 4.894216399848055 52.38281218082274, 4.893688099847538 52.38281668082269, 4.893401699847259 52.38283798082266, 4.893271199847132 52.38302378082242, 4.892931999846801 52.38383728082119, 4.89294079984681 52.38415378082069, 4.89299989984687 52.38432018082044, 4.893241999847108 52.385002680819404, 4.893267099847135 52.38544588081876, 4.893017299846891 52.385977380817934, 4.892713499846596 52.386637180816905, 4.892115999846016 52.388076280814765, 4.89177879984569 52.388703780813785, 4.891512399845432 52.38937528081275, 4.891353599845277 52.38948938081258, 4.890781099844719 52.38968898081231, 4.889781599843742 52.3898156808121, 4.886092699840135 52.39029598081136, 4.885832099839882 52.390365980811254, 4.885037299839103 52.39064958081083, 4.884935999839005 52.390316280811334, 4.884856699838928 52.39002898081176, 4.884007699838094 52.388257080814476, 4.882985799837086 52.38654928081702, 4.882904899837008 52.386184880817574, 4.8827024998368085 52.3859702808179, 4.882548599836657 52.385807180818155, 4.882296099836409 52.385752280818224, 4.881913399836038 52.3858516808181, 4.881582699835716 52.385890680818, 4.881488199835621 52.38581388081815, 4.881321999835457 52.38526548081895, 4.88138859983552 52.38469778081978, 4.881389899835522 52.384457580820175, 4.880517399834664 52.383105880822214, 4.8803503998345015 52.38284518082262, 4.880034499834189 52.38259678082301, 4.879341599833512 52.382307080823416, 4.879122899833297 52.38218488082359, 4.878970099833148 52.3820741808238, 4.879111599833286 52.38157418082455, 4.879267299833437 52.38143118082473, 4.879297599833469 52.38134598082487, 4.879272299833441 52.38099568082539, 4.878870699833044 52.38031618082646, 4.877910799832102 52.37879068082875, 4.8777003998318955 52.37860778082902, 4.877012699831219 52.377456880830714, 4.876792499831005 52.37711208083127, 4.8758777998301035 52.37567168083346, 4.8752040998294435 52.37460688083503, 4.875040899829281 52.37413018083577, 4.875056799829295 52.373703780836415, 4.875015199829253 52.373499280836725, 4.874831099829073 52.37316008083721, 4.874428199828677 52.37287258083767, 4.874202599828456 52.3727122808379, 4.874031099828289 52.372532480838196, 4.873954799828211 52.372262180838604, 4.87399429982825 52.3720381808389, 4.874070599828325 52.37176208083935, 4.874451699828694 52.37084098084071, 4.874646599828884 52.370482680841285, 4.875184399829407 52.369326580842994, 4.875448899829662 52.36897298084356, 4.875767399829974 52.36870498084392, 4.876203199830399 52.36839388084439, 4.876514199830704 52.368187380844724, 4.876763299830948 52.36789658084517, 4.8768580998310345 52.36762538084557, 4.876865299831041 52.36731328084606, 4.87691259983109 52.367030680846455, 4.877017999831191 52.36679758084681, 4.877259699831425 52.36650908084727, 4.877630099831788 52.36622848084773, 4.878036699832184 52.36597018084808, 4.878444099832582 52.3656337808486, 4.87859629983273 52.36540358084893, 4.87865739983279 52.36518828084927, 4.878664399832792 52.36494558084959, 4.878603999832736 52.36465928085005, 4.878544199832676 52.36432098085056, 4.878735999832862 52.36377198085139, 4.878730199832856 52.363635080851545, 4.8789992998331195 52.3635149808518, 4.879106499833226 52.36343918085185, 4.880196999834286 52.362806680852856, 4.8809029998349756 52.36219858085377, 4.881417699835481 52.361927680854166, 4.88228069983632 52.3616521808546, 4.882540599836577 52.36168918085454, 4.883519999837531 52.361666480854545, 4.883992099837996 52.361548580854766, 4.884532499838522 52.36130478085511, 4.885093199839069 52.36101308085556, 4.886745599840683 52.360162480856864, 4.887527799841446 52.35973478085749, 4.8877570998416715 52.35955838085774, 4.887968399841878 52.359357280858084, 4.888387399842284 52.35898358085863, 4.888590499842484 52.35882108085886, 4.889022799842904 52.35852428085932, 4.88968219984355 52.35825538085972, 4.8901234998439795 52.35813828085991, 4.890692999844536 52.358032880860065, 4.891720399845542 52.35800528086012, 4.897891499851577 52.35763638086072, 4.898371999852045 52.357627080860716, 4.899290399852943 52.35779698086045, 4.900872399854493 52.35814728085995, 4.903522999857087 52.35869888085914, 4.903798199857354 52.358682080859154, 4.905196099858727 52.35895808085877, 4.906340099859844 52.359222880858326, 4.907079599860568 52.3595768808578, 4.907839999861314 52.35997008085723, 4.908622999862079 52.360233280856875, 4.909238199862681 52.36030078085675, 4.910129899863553 52.360330480856724, 4.910681499864093 52.360384680856605, 4.911311999864711 52.36068138085619, 4.911928499865313 52.36098018085573, 4.912484799865856 52.36108568085553, 4.913477999866829 52.36113238085547, 4.914092299867429 52.36120458085535, 4.914700299868024 52.36136618085512, 4.915288899868602 52.3615369808549, 4.9161461998694405 52.36179788085451, 4.9171009998703745 52.36189268085435, 4.917928999871183 52.3619219808543, 4.918522899871766 52.362002380854236, 4.91926259987249 52.362356380853655, 4.919895099873109 52.362800980853024, 4.9204023998736055 52.36303698085264, 4.921866499875039 52.36317278085244, 4.922818999875969 52.36348868085198, 4.923297299876437 52.36396188085124, 4.924827699877937 52.364878080849884, 4.926068299879154 52.36558188084885, 4.926781799879852 52.365909680848326, 4.92803009988107 52.36595358084825, 4.929291099882306 52.36601228084815, 4.930285199883277 52.3660532808481, 4.931187599884159 52.36608928084809, 4.932116799885068 52.36610908084808, 4.9329740998859055 52.36609768084805, 4.933507199886428 52.366113680848045, 4.9337752998866895 52.36620118084793, 4.933860299886775 52.36636058084766)
            """;

    private static final String WKT_MULTI_LINE_STRING = """
            MULTILINESTRING ((4.9338603 52.3663605, 4.9338526 52.366514, 4.933757 52.3684361, 4.9337898 52.3687962, 4.9339333 52.3693078, 4.9341349 52.3698188, 4.9341569 52.3711136, 4.9341117 52.3716435, 4.9337476 52.3724052, 4.9334156 52.3728407, 4.9326158 52.373485, 4.9318635 52.3739341, 4.9312773 52.3741914, 4.9302838 52.3745977, 4.9290253 52.3750505, 4.9281342 52.3752535, 4.9246812 52.3758567, 4.9163436 52.3770237, 4.9143954 52.377246, 4.9127542 52.3773853, 4.9115971 52.3774679, 4.910335 52.3775507, 4.9072011 52.3779497, 4.9050415 52.3782275, 4.9039967 52.378503, 4.9032023 52.3787547, 4.9020095 52.3792343, 4.8999391 52.3799525, 4.8976594 52.3807463, 4.8972169 52.3809288, 4.8969663 52.3810801, 4.896747 52.3812125, 4.8963398 52.381452, 4.8955439 52.3821405, 4.8951079 52.382488, 4.894647 52.3826971, 4.8942164 52.3828121, 4.8936881 52.3828166, 4.8934017 52.3828379, 4.8932712 52.3830237, 4.892932 52.3838372, 4.8929408 52.3841537, 4.8929999 52.3843201, 4.893242 52.3850026, 4.8932671 52.3854458, 4.8930173 52.3859773, 4.8927135 52.3866371, 4.892116 52.3880762, 4.8917788 52.3887037, 4.8915124 52.3893752, 4.8913536 52.3894893, 4.8907811 52.3896889, 4.8897816 52.3898156, 4.8860927 52.3902959, 4.8858321 52.3903659, 4.8850373 52.3906495, 4.884936 52.3903162, 4.8848567 52.3900289, 4.8840077 52.388257, 4.8829858 52.3865492, 4.8829049 52.3861848, 4.8827025 52.3859702, 4.8825486 52.3858071, 4.8822961 52.3857522, 4.8819134 52.3858516, 4.8815827 52.3858906, 4.8814882 52.3858138, 4.881322 52.3852654, 4.8813886 52.3846977, 4.8813899 52.3844575, 4.8805174 52.3831058, 4.8803504 52.3828451, 4.8800345 52.3825967, 4.8793416 52.382307, 4.8791229 52.3821848, 4.8789701 52.3820741, 4.8791116 52.3815741, 4.8792673 52.3814311, 4.8792976 52.3813459, 4.8792723 52.3809956, 4.8788707 52.3803161, 4.8779108 52.3787906, 4.8777004 52.3786077, 4.8770127 52.3774568, 4.8767925 52.377112, 4.8758778 52.3756716, 4.8752041 52.3746068, 4.8750409 52.3741301, 4.8750568 52.3737037, 4.8750152 52.3734992, 4.8748311 52.37316, 4.8744282 52.3728725, 4.8742026 52.3727122, 4.8740311 52.3725324, 4.8739548 52.3722621, 4.8739943 52.3720381, 4.8740706 52.371762, 4.8744517 52.3708409, 4.8746466 52.3704826, 4.8751844 52.3693265, 4.8754489 52.3689729, 4.8757674 52.3687049, 4.8762032 52.3683938, 4.8765142 52.3681873, 4.8767633 52.3678965, 4.8768581 52.3676253, 4.8768653 52.3673132, 4.8769126 52.3670306, 4.877018 52.3667975, 4.8772597 52.366509, 4.8776301 52.3662284, 4.8780367 52.3659701, 4.8784441 52.3656337, 4.8785963 52.3654035, 4.8786574 52.3651882, 4.8786644 52.3649455, 4.878604 52.3646592, 4.8785442 52.3643209, 4.878736 52.3637719, 4.8787302 52.363635, 4.8789993 52.3635149, 4.8791065 52.3634391, 4.880197 52.3628066, 4.880903 52.3621985, 4.8814177 52.3619276, 4.8822807 52.3616521, 4.8825406 52.3616891, 4.88352 52.3616664, 4.8839921 52.3615485, 4.8845325 52.3613047, 4.8850932 52.361013, 4.8867456 52.3601624, 4.8875278 52.3597347, 4.8877571 52.3595583, 4.8879684 52.3593572, 4.8883874 52.3589835, 4.8885905 52.358821, 4.8890228 52.3585242, 4.8896822 52.3582553, 4.8901235 52.3581382, 4.890693 52.3580328, 4.8917204 52.3580052, 4.8978915 52.3576363, 4.898372 52.357627, 4.8992904 52.3577969, 4.9008724 52.3581472, 4.903523 52.3586988, 4.9037982 52.358682, 4.9051961 52.358958, 4.9063401 52.3592228, 4.9070796 52.3595768, 4.90784 52.35997, 4.908623 52.3602332, 4.9092382 52.3603007, 4.9101299 52.3603304, 4.9106815 52.3603846, 4.911312 52.3606813, 4.9119285 52.3609801, 4.9124848 52.3610856, 4.913478 52.3611323, 4.9140923 52.3612045, 4.9147003 52.3613661, 4.9152889 52.3615369, 4.9161462 52.3617978, 4.917101 52.3618926, 4.917929 52.3619219, 4.9185229 52.3620023, 4.9192626 52.3623563, 4.9198951 52.3628009, 4.9204024 52.3630369, 4.9218665 52.3631727, 4.922819 52.3634886, 4.9232973 52.3639618, 4.9248277 52.364878, 4.9260683 52.3655818, 4.9267818 52.3659096, 4.9280301 52.3659535, 4.9292911 52.3660122, 4.9302852 52.3660532, 4.9311876 52.3660892, 4.9321168 52.366109, 4.9329741 52.3660976, 4.9335072 52.3661136, 4.9337753 52.3662011, 4.9338603 52.3663605))
            """;

    @Autowired
    private MultiLineStringPointGeometryMatcher multiLineStringPointGeometryMatcher;

    @SneakyThrows
    @Test
    void matchPointOnLine() {
        WKTReader wktReader = new WKTReader();
        MultiLineString multiLineString = (MultiLineString) wktReader.read(WKT_MULTI_LINE_STRING);
        String wktPoint = "POINT (4.8857329 52.3904013)";
        Point point = (Point) wktReader.read(wktPoint);
        LineString lineString = multiLineStringPointGeometryMatcher.matchPointOnMultiLine(multiLineString, point, 25);
        LineString expectedLineString = (LineString) wktReader.read(WKT_EXPECTED_LINE_STRING);
        assertThat(lineString).isEqualTo(expectedLineString);
    }

    @SneakyThrows
    @Test
    void matchPointOnLine_noMatch_Exception() {
        WKTReader wktReader = new WKTReader();
        MultiLineString multiLineString = (MultiLineString) wktReader.read(WKT_MULTI_LINE_STRING);
        String wktPoint = "POINT (4.9857329 52.3904013)";
        Point point = (Point) wktReader.read(wktPoint);

        assertThatThrownBy(() -> multiLineStringPointGeometryMatcher.matchPointOnMultiLine(multiLineString, point, 25))
                .isInstanceOf(IllegalStateException.class).hasMessage("No matching line found for point POINT (4.9857329 52.3904013)");
    }
}
