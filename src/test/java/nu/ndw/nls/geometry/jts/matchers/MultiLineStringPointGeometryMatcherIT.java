package nu.ndw.nls.geometry.jts.matchers;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

import lombok.SneakyThrows;
import nu.ndw.nls.geometry.GeometryConfiguration;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.locationtech.jts.geom.LineString;
import org.locationtech.jts.geom.MultiLineString;
import org.locationtech.jts.geom.Point;
import org.locationtech.jts.io.WKTReader;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = {GeometryConfiguration.class})
class MultiLineStringPointGeometryMatcherIT {

    private static final String WKT_MULTI_LINE_STRING = """
            MULTILINESTRING ((4.9338603 52.3663605, 4.9338526 52.366514, 4.933757 52.3684361, 4.9337898 52.3687962, 4.9339333 52.3693078, 4.9341349 52.3698188, 4.9341569 52.3711136, 4.9341117 52.3716435, 4.9337476 52.3724052, 4.9334156 52.3728407, 4.9326158 52.373485, 4.9318635 52.3739341, 4.9312773 52.3741914, 4.9302838 52.3745977, 4.9290253 52.3750505, 4.9281342 52.3752535, 4.9246812 52.3758567, 4.9163436 52.3770237, 4.9143954 52.377246, 4.9127542 52.3773853, 4.9115971 52.3774679, 4.910335 52.3775507, 4.9072011 52.3779497, 4.9050415 52.3782275, 4.9039967 52.378503, 4.9032023 52.3787547, 4.9020095 52.3792343, 4.8999391 52.3799525, 4.8976594 52.3807463, 4.8972169 52.3809288, 4.8969663 52.3810801, 4.896747 52.3812125, 4.8963398 52.381452, 4.8955439 52.3821405, 4.8951079 52.382488, 4.894647 52.3826971, 4.8942164 52.3828121, 4.8936881 52.3828166, 4.8934017 52.3828379, 4.8932712 52.3830237, 4.892932 52.3838372, 4.8929408 52.3841537, 4.8929999 52.3843201, 4.893242 52.3850026, 4.8932671 52.3854458, 4.8930173 52.3859773, 4.8927135 52.3866371, 4.892116 52.3880762, 4.8917788 52.3887037, 4.8915124 52.3893752, 4.8913536 52.3894893, 4.8907811 52.3896889, 4.8897816 52.3898156, 4.8860927 52.3902959, 4.8858321 52.3903659, 4.8850373 52.3906495, 4.884936 52.3903162, 4.8848567 52.3900289, 4.8840077 52.388257, 4.8829858 52.3865492, 4.8829049 52.3861848, 4.8827025 52.3859702, 4.8825486 52.3858071, 4.8822961 52.3857522, 4.8819134 52.3858516, 4.8815827 52.3858906, 4.8814882 52.3858138, 4.881322 52.3852654, 4.8813886 52.3846977, 4.8813899 52.3844575, 4.8805174 52.3831058, 4.8803504 52.3828451, 4.8800345 52.3825967, 4.8793416 52.382307, 4.8791229 52.3821848, 4.8789701 52.3820741, 4.8791116 52.3815741, 4.8792673 52.3814311, 4.8792976 52.3813459, 4.8792723 52.3809956, 4.8788707 52.3803161, 4.8779108 52.3787906, 4.8777004 52.3786077, 4.8770127 52.3774568, 4.8767925 52.377112, 4.8758778 52.3756716, 4.8752041 52.3746068, 4.8750409 52.3741301, 4.8750568 52.3737037, 4.8750152 52.3734992, 4.8748311 52.37316, 4.8744282 52.3728725, 4.8742026 52.3727122, 4.8740311 52.3725324, 4.8739548 52.3722621, 4.8739943 52.3720381, 4.8740706 52.371762, 4.8744517 52.3708409, 4.8746466 52.3704826, 4.8751844 52.3693265, 4.8754489 52.3689729, 4.8757674 52.3687049, 4.8762032 52.3683938, 4.8765142 52.3681873, 4.8767633 52.3678965, 4.8768581 52.3676253, 4.8768653 52.3673132, 4.8769126 52.3670306, 4.877018 52.3667975, 4.8772597 52.366509, 4.8776301 52.3662284, 4.8780367 52.3659701, 4.8784441 52.3656337, 4.8785963 52.3654035, 4.8786574 52.3651882, 4.8786644 52.3649455, 4.878604 52.3646592, 4.8785442 52.3643209, 4.878736 52.3637719, 4.8787302 52.363635, 4.8789993 52.3635149, 4.8791065 52.3634391, 4.880197 52.3628066, 4.880903 52.3621985, 4.8814177 52.3619276, 4.8822807 52.3616521, 4.8825406 52.3616891, 4.88352 52.3616664, 4.8839921 52.3615485, 4.8845325 52.3613047, 4.8850932 52.361013, 4.8867456 52.3601624, 4.8875278 52.3597347, 4.8877571 52.3595583, 4.8879684 52.3593572, 4.8883874 52.3589835, 4.8885905 52.358821, 4.8890228 52.3585242, 4.8896822 52.3582553, 4.8901235 52.3581382, 4.890693 52.3580328, 4.8917204 52.3580052, 4.8978915 52.3576363, 4.898372 52.357627, 4.8992904 52.3577969, 4.9008724 52.3581472, 4.903523 52.3586988, 4.9037982 52.358682, 4.9051961 52.358958, 4.9063401 52.3592228, 4.9070796 52.3595768, 4.90784 52.35997, 4.908623 52.3602332, 4.9092382 52.3603007, 4.9101299 52.3603304, 4.9106815 52.3603846, 4.911312 52.3606813, 4.9119285 52.3609801, 4.9124848 52.3610856, 4.913478 52.3611323, 4.9140923 52.3612045, 4.9147003 52.3613661, 4.9152889 52.3615369, 4.9161462 52.3617978, 4.917101 52.3618926, 4.917929 52.3619219, 4.9185229 52.3620023, 4.9192626 52.3623563, 4.9198951 52.3628009, 4.9204024 52.3630369, 4.9218665 52.3631727, 4.922819 52.3634886, 4.9232973 52.3639618, 4.9248277 52.364878, 4.9260683 52.3655818, 4.9267818 52.3659096, 4.9280301 52.3659535, 4.9292911 52.3660122, 4.9302852 52.3660532, 4.9311876 52.3660892, 4.9321168 52.366109, 4.9329741 52.3660976, 4.9335072 52.3661136, 4.9337753 52.3662011, 4.9338603 52.3663605))
            """;

    @Autowired
    private MultiLineStringPointGeometryMatcher multiLineStringPointGeometryMatcher;

    @SneakyThrows
    @Test
    void matchPointOnLine() {
        WKTReader wktReader = new WKTReader();
        MultiLineString multiLineString = (MultiLineString) wktReader.read(WKT_MULTI_LINE_STRING);
        String wktPoint = "POINT (4.8857329 52.3904013)";
        Point point = (Point) wktReader.read(wktPoint);
        LineString lineString = multiLineStringPointGeometryMatcher.matchPointOnMultiLine(multiLineString, point, 25);
        assertThat(lineString).isEqualTo(multiLineString.getGeometryN(0));
    }

    @SneakyThrows
    @Test
    void matchPointOnLine_noMatch_Exception() {
        WKTReader wktReader = new WKTReader();
        MultiLineString multiLineString = (MultiLineString) wktReader.read(WKT_MULTI_LINE_STRING);
        String wktPoint = "POINT (4.9857329 52.3904013)";
        Point point = (Point) wktReader.read(wktPoint);
        assertThatThrownBy(() -> multiLineStringPointGeometryMatcher.matchPointOnMultiLine(multiLineString, point, 25))
                .isInstanceOf(IllegalStateException.class).hasMessage("No matching line found for point POINT (4.9857329 52.3904013)");
    }
}
